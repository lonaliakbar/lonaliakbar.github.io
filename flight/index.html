<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAX INFO RADAR - Technical Monitor</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* TEMA MILITER / ENGINEERING (Hitam & Hijau Terminal) */
        body { margin: 0; padding: 0; background: #000; font-family: 'Share Tech Mono', monospace; overflow: hidden; color: #0f0; }
        
        #map { height: 100vh; width: 100%; background: #050505; z-index: 1; }

        /* HUD ATAS */
        #top-hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 40px;
            background: rgba(0, 20, 0, 0.9); border-bottom: 1px solid #00ff00;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; box-sizing: border-box;
        }
        .sys-status { font-size: 14px; animation: blink 2s infinite; }

        /* SIDEBAR SUPER DETAIL */
        #detail-panel {
            position: absolute; top: 40px; right: -400px; /* Sembunyi */
            width: 380px; height: calc(100vh - 40px);
            background: #0a0a0a; border-left: 2px solid #00ff00;
            z-index: 1100; transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            overflow-y: auto; display: flex; flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.8);
        }
        #detail-panel.active { right: 0; }

        /* ISI PANEL */
        .panel-header {
            background: #003300; padding: 15px; border-bottom: 1px solid #00ff00;
        }
        .big-code { font-size: 32px; font-weight: bold; color: #fff; margin: 0; letter-spacing: 2px; }
        .sub-code { color: #00ff00; font-size: 12px; text-transform: uppercase; }

        .data-section { padding: 15px; border-bottom: 1px dashed #333; }
        .sec-title { color: #555; font-size: 10px; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; border-left: 3px solid #00ff00; padding-left: 5px; }

        /* GRID SYSTEM DATA */
        .d-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .d-item { background: #111; padding: 8px; border: 1px solid #222; border-radius: 4px; }
        .d-label { display: block; font-size: 10px; color: #888; margin-bottom: 2px; }
        .d-val { display: block; font-size: 14px; color: #e0e0e0; font-weight: bold; }
        .highlight { color: #00ff00; }
        .warning { color: #ff3333; }

        /* TOMBOL GAMBAR & TRACK */
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn-action {
            flex: 1; background: #004400; border: 1px solid #00ff00; color: #00ff00;
            padding: 10px; cursor: pointer; font-family: 'Share Tech Mono', monospace;
            transition: 0.2s; text-transform: uppercase; font-size: 11px;
        }
        .btn-action:hover { background: #00ff00; color: black; }

        /* ICON PESAWAT */
        .plane-marker {
            transition: transform 0.5s;
        }
        .arrow-glyph {
            font-size: 20px; color: #00ff00; text-shadow: 0 0 8px #00ff00;
            display: block; text-align: center;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #004400; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="top-hud">
        <span>‚úà SYSTEM: <span style="color:#fff">ONLINE</span></span>
        <span id="aircraft-count" class="sys-status">SCANNING...</span>
    </div>

    <div id="detail-panel">
        <button onclick="closePanel()" style="background:#330000; color:red; border:none; padding:10px; cursor:pointer; width:100%; font-weight:bold;">[ X ] TUTUP PANEL DATA</button>
        
        <div class="panel-header">
            <h1 class="big-code" id="p-callsign">N/A</h1>
            <div class="sub-code" id="p-country">UNKNOWN REGION</div>
            <div style="margin-top:5px; font-size:11px; color:#aaa;">ICAO HEX: <span id="p-icao" style="color:#fff">---</span></div>
        </div>

        <div class="data-section">
            <div class="sec-title">NAVIGASI & POSISI</div>
            <div class="d-grid">
                <div class="d-item">
                    <span class="d-label">LATITUDE</span>
                    <span class="d-val" id="p-lat">0.0000</span>
                </div>
                <div class="d-item">
                    <span class="d-label">LONGITUDE</span>
                    <span class="d-val" id="p-lon">0.0000</span>
                </div>
                <div class="d-item">
                    <span class="d-label">HEADING (ARAH)</span>
                    <span class="d-val" id="p-heading">0¬∞ (N)</span>
                </div>
                <div class="d-item">
                    <span class="d-label">SQUAWK CODE</span>
                    <span class="d-val highlight" id="p-squawk">----</span>
                </div>
            </div>
        </div>

        <div class="data-section">
            <div class="sec-title">FISIKA PENERBANGAN</div>
            <div class="d-grid">
                <div class="d-item">
                    <span class="d-label">ALTITUDE (BARO)</span>
                    <span class="d-val" id="p-alt-baro">0 ft</span>
                </div>
                <div class="d-item">
                    <span class="d-label">ALTITUDE (GPS/GEO)</span>
                    <span class="d-val" id="p-alt-geo">0 ft</span>
                </div>
                <div class="d-item">
                    <span class="d-label">GROUND SPEED</span>
                    <span class="d-val" id="p-spd">0 km/h</span>
                </div>
                <div class="d-item">
                    <span class="d-label">MACH (Approx)</span>
                    <span class="d-val" id="p-mach">M 0.0</span>
                </div>
            </div>
        </div>

        <div class="data-section">
            <div class="sec-title">STATUS VERTIKAL</div>
            <div class="d-item" style="width: 100%; box-sizing: border-box;">
                <span class="d-label">VERTICAL RATE</span>
                <span class="d-val" id="p-vrate" style="font-size: 18px;">0 fpm</span>
            </div>
            <div id="p-vstatus" style="margin-top:5px; font-size:12px; text-align:center; padding:5px; background:#111; border:1px solid #333;">
                STABIL (CRUISING)
            </div>
        </div>

        <div class="data-section">
            <div class="sec-title">SINYAL & SENSOR</div>
            <div class="d-grid">
                <div class="d-item">
                    <span class="d-label">SUMBER POSISI</span>
                    <span class="d-val" id="p-source">ADS-B</span>
                </div>
                <div class="d-item">
                    <span class="d-label">KATEGORI</span>
                    <span class="d-val" id="p-category">No Info</span>
                </div>
                <div class="d-item">
                    <span class="d-label">LAST CONTACT</span>
                    <span class="d-val" id="p-contact">0s ago</span>
                </div>
                <div class="d-item">
                    <span class="d-label">ON GROUND?</span>
                    <span class="d-val" id="p-ground">NO</span>
                </div>
            </div>
        </div>

        <div class="data-section">
            <div class="sec-title">DATA INTELEJEN EKSTERNAL</div>
            <div class="btn-group">
                <button class="btn-action" onclick="openPhoto()">üì∏ FOTO FISIK</button>
                <button class="btn-action" onclick="openRoute()">üó∫Ô∏è RUTE LENGKAP</button>
            </div>
            <div class="btn-group">
                 <button class="btn-action" onclick="openGoogle()">üîç GOOGLE</button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- SETUP PETA ---
        const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([-2, 118], 5);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Map Gelap (CartoDB Dark)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19, attribution: 'Data: OpenSky Network'
        }).addTo(map);

        const planeLayer = L.layerGroup().addTo(map);

        // Variabel Global untuk menyimpan data pesawat yang sedang dipilih
        let currentPlane = null;

        // --- FUNGSI UPDATE DATA ---
        async function refreshRadar() {
            try {
                // Fetch Area (Indonesia & Sekitarnya agar cepat, bisa diubah ke all)
                // Kita pakai ALL tapi di filter client side untuk performa
                const response = await fetch("https://opensky-network.org/api/states/all"); 
                const data = await response.json();

                if(!data.states) return;

                document.getElementById('aircraft-count').innerText = `${data.states.length} UNIT TERDETEKSI`;

                planeLayer.clearLayers();

                // Optimasi: Hanya render yang masuk layar (Viewport)
                const bounds = map.getBounds();

                data.states.forEach(state => {
                    const lat = state[6];
                    const lon = state[5];

                    if(lat && lon && bounds.contains([lat, lon])) {
                        const heading = state[10] || 0;
                        const callsign = state[1].trim();
                        const onGround = state[8];

                        // Ikon Panah Putar
                        const icon = L.divIcon({
                            className: 'plane-marker',
                            html: `<div class="arrow-glyph" style="transform: rotate(${heading}deg); color: ${onGround ? '#555' : '#00ff00'}">‚û§</div>`,
                            iconSize: [20, 20], iconAnchor: [10, 10]
                        });

                        L.marker([lat, lon], {icon: icon})
                            .addTo(planeLayer)
                            .on('click', () => showFullDetails(state));
                    }
                });

            } catch (e) {
                console.log("Koneksi Error/Rate Limit", e);
                document.getElementById('aircraft-count').innerText = "OFFLINE / RECONNECTING";
            }
        }

        // --- FUNGSI TAMPILKAN DETAIL (INTI PERMINTAAN ANDA) ---
        function showFullDetails(data) {
            currentPlane = {
                icao: data[0],
                callsign: data[1].trim(),
                lat: data[6],
                lon: data[5]
            };

            // 1. Parsing Data Mentah
            const icao = data[0].toUpperCase();
            const callsign = data[1].trim() || "NO CALLSIGN";
            const country = data[2];
            const timePos = data[3];
            const lastContact = data[4];
            const lon = data[5];
            const lat = data[6];
            const altBaro = data[7]; // Meter
            const onGround = data[8];
            const velocity = data[9]; // m/s
            const heading = data[10]; // degrees
            const vRate = data[11]; // m/s
            // index 12 sensors
            const altGeo = data[13]; // Meter (GPS)
            const squawk = data[14] || "N/A";
            const spi = data[15];
            const posSource = data[16];

            // 2. Kalkulasi & Konversi (SEBANYAK-BANYAKNYA)
            
            // Ketinggian: Meter -> Feet
            const altBaroFt = altBaro ? Math.round(altBaro * 3.28084).toLocaleString() : "N/A";
            const altGeoFt = altGeo ? Math.round(altGeo * 3.28084).toLocaleString() : "N/A";
            
            // Kecepatan: m/s -> km/h & Mach
            const spdKmh = velocity ? Math.round(velocity * 3.6) : 0;
            const mach = velocity ? (spdKmh / 1234.8).toFixed(2) : "0.00";
            
            // Vertical Rate: m/s -> ft/min (Standar penerbangan)
            const vRateFpm = vRate ? Math.round(vRate * 196.85) : 0;

            // Arah Kompas
            const directions = ["U (N)", "TL (NE)", "T (E)", "TG (SE)", "S (S)", "BD (SW)", "B (W)", "BL (NW)"];
            const compass = directions[Math.round(((heading || 0) % 360) / 45) % 8];

            // Status Analisa
            let statusText = "‚úà STABIL (CRUISING)";
            let statusColor = "#00ff00"; // Hijau
            if (onGround) {
                statusText = "üöó DI DARAT (TAXI/PARK)";
                statusColor = "#888"; 
            } else if (vRateFpm > 200) {
                statusText = "‚Üó SEDANG MENANJAK (CLIMBING)";
                statusColor = "#00ffff"; // Cyan
            } else if (vRateFpm < -200) {
                statusText = "‚Üò SEDANG TURUN (DESCENDING)";
                statusColor = "#ffaa00"; // Orange
            }
            if (squawk == "7700" || squawk == "7600" || squawk == "7500") {
                statusText = "‚ö† EMERGENCY / MAYDAY";
                statusColor = "red";
            }

            // Sumber Posisi
            const sources = ["ADS-B", "ASTERIX", "MLAT", "FLARM"];
            const sourceName = sources[posSource] || "UNKNOWN";

            // 3. Masukkan ke HTML
            document.getElementById('p-callsign').innerText = callsign;
            document.getElementById('p-country').innerText = country;
            document.getElementById('p-icao').innerText = icao;

            document.getElementById('p-lat').innerText = lat.toFixed(5);
            document.getElementById('p-lon').innerText = lon.toFixed(5);
            document.getElementById('p-heading').innerText = `${Math.round(heading)}¬∞ ${compass}`;
            document.getElementById('p-squawk').innerText = squawk;

            document.getElementById('p-alt-baro').innerText = altBaroFt + " ft";
            document.getElementById('p-alt-geo').innerText = altGeoFt + " ft";
            document.getElementById('p-spd').innerText = spdKmh + " km/h";
            document.getElementById('p-mach').innerText = "Mach " + mach;

            const vrEl = document.getElementById('p-vrate');
            vrEl.innerText = (vRateFpm > 0 ? "+" : "") + vRateFpm + " fpm";
            vrEl.style.color = vRateFpm > 0 ? "#00ffff" : (vRateFpm < 0 ? "#ffaa00" : "#fff");

            const stEl = document.getElementById('p-vstatus');
            stEl.innerText = statusText;
            stEl.style.color = statusColor;
            stEl.style.borderColor = statusColor;

            document.getElementById('p-source').innerText = sourceName;
            document.getElementById('p-contact').innerText = (Date.now()/1000 - lastContact).toFixed(1) + "s ago";
            document.getElementById('p-ground').innerText = onGround ? "YES" : "NO";

            // Buka Panel
            document.getElementById('detail-panel').classList.add('active');
        }

        function closePanel() {
            document.getElementById('detail-panel').classList.remove('active');
        }

        // --- FUNGSI TOMBOL EKSTERNAL ---
        function openPhoto() {
            if(!currentPlane) return;
            // Cari di JetPhotos menggunakan ICAO Hex atau Callsign
            // URL JetPhotos search pattern
            const url = `https://www.jetphotos.com/photo/keyword/${currentPlane.icao}`;
            window.open(url, '_blank');
        }

        function openRoute() {
            if(!currentPlane) return;
            const url = `https://flightaware.com/live/flight/${currentPlane.callsign}`;
            window.open(url, '_blank');
        }
        
        function openGoogle() {
            if(!currentPlane) return;
            const url = `https://www.google.com/search?q=${currentPlane.callsign}+aircraft+owner`;
            window.open(url, '_blank');
        }

        // Loop Update
        setInterval(refreshRadar, 10000);
        refreshRadar();

    </script>
</body>
</html>
