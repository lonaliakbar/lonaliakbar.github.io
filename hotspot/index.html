<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Fire Tracker - Full Date WIB</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        .dashboard {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(0, 0, 0, 0.85); color: white; padding: 25px;
            border-radius: 15px; backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.15); width: 280px;
        }
        h2 { margin: 0; color: #ff4d4d; font-size: 20px; letter-spacing: 1px; }
        .sub-title { font-size: 10px; text-transform: uppercase; color: #aaa; margin-bottom: 5px; display: block; }
        
        .control-group { margin-top: 15px; }
        label { font-size: 11px; font-weight: bold; color: #ddd; text-transform: uppercase; }
        
        select {
            width: 100%; padding: 10px; margin: 5px 0 10px 0;
            background: #222; color: white; border: 1px solid #444;
            border-radius: 8px; cursor: pointer; font-size: 13px;
        }
        
        .info-card {
            margin-top: 10px; padding: 15px; background: rgba(255, 77, 77, 0.1);
            border-radius: 10px; border-left: 4px solid #ff4d4d;
        }
        #fire-count { font-size: 24px; color: #ff4d4d; }
        .status-text { font-size: 12px; display: block; margin-bottom: 5px; }
        
        .btn-aceh {
            margin-top: 15px; width: 100%; padding: 12px;
            background: #d32f2f; color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="dashboard">
        <span class="sub-title">Sistem Monitoring NASA</span>
        <h2>FIRE TRACKER</h2>
        
        <div class="control-group">
            <label>Tampilan Peta:</label>
            <select id="map-select" onchange="changeBasemap()">
                <option value="satellite">Satelit Murni</option>
                <option value="hybrid">Satelit + Label</option>
                <option value="light">Peta Terang</option>
                <option value="dark">Peta Gelap</option>
            </select>
        </div>

        <div class="control-group">
            <label>Pilih Satelit:</label>
            <select id="sat-source" onchange="updateData()">
                <option value="viirs_snpp">VIIRS SNPP (Detail)</option>
                <option value="noaa20">NOAA-20 (J1)</option>
                <option value="noaa21">NOAA-21 (J2)</option>
                <option value="modis">MODIS (Standar)</option>
            </select>
        </div>

        <div class="info-card">
            <span id="status" class="status-text">‚è≥ Menyiapkan...</span>
            <div id="details" style="display:none;">
                <b id="fire-count">0</b> <span style="font-size: 13px;">Titik Api Dunia</span>
            </div>
        </div>
        
        <button class="btn-aceh" onclick="zoomToAceh()">üìç FOKUS KE ACEH</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([10, 20], 3);

        const basemaps = {
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
            light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
        };

        let currentBasemap = basemaps.satellite.addTo(map);
        let labelLayer = null;

        function changeBasemap() {
            const selected = document.getElementById('map-select').value;
            map.removeLayer(currentBasemap);
            if(labelLayer) map.removeLayer(labelLayer);
            labelLayer = null;

            if (selected === 'satellite') {
                currentBasemap = basemaps.satellite.addTo(map);
            } else if (selected === 'hybrid') {
                currentBasemap = basemaps.satellite.addTo(map);
                labelLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}').addTo(map);
            } else if (selected === 'light') {
                currentBasemap = basemaps.light.addTo(map);
            } else if (selected === 'dark') {
                currentBasemap = basemaps.dark.addTo(map);
            }
        }

        // --- FUNGSI FORMAT TANGGAL & WAKTU INDONESIA ---
        function formatFullWIB(utcDate, utcTime) {
            let timeStr = utcTime.toString().padStart(4, '0');
            let dateObj = new Date(utcDate + 'T' + timeStr.substring(0, 2) + ':' + timeStr.substring(2, 4) + ':00Z');
            
            // Tambah 7 jam untuk WIB
            dateObj.setHours(dateObj.getHours() + 7);

            const opsi = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };

            return dateObj.toLocaleDateString('id-ID', opsi) + " WIB";
        }

        const proxy = "https://cors-anywhere.herokuapp.com/";
        const db = {
            modis: "https://firms2.modaps.eosdis.nasa.gov/data/active_fire/modis-c6.1/csv/MODIS_C6_1_Global_24h.csv",
            viirs_snpp: "https://firms2.modaps.eosdis.nasa.gov/data/active_fire/suomi-npp-viirs-c2/csv/SUOMI_VIIRS_C2_Global_24h.csv",
            noaa20: "https://firms2.modaps.eosdis.nasa.gov/data/active_fire/noaa-20-viirs-c2/csv/J1_VIIRS_C2_Global_24h.csv",
            noaa21: "https://firms2.modaps.eosdis.nasa.gov/data/active_fire/noaa-21-viirs-c2/csv/J2_VIIRS_C2_Global_24h.csv"
        };

        let dataLayer = L.layerGroup().addTo(map);

        async function updateData() {
            const satType = document.getElementById('sat-source').value;
            const statusEl = document.getElementById('status');
            dataLayer.clearLayers();
            statusEl.innerText = "‚è≥ Mendownload Data Dunia...";

            try {
                const response = await fetch(proxy + db[satType]);
                const csvData = await response.text();
                
                Papa.parse(csvData, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(res) {
                        let total = 0;
                        res.data.forEach(d => {
                            if (d.latitude && d.longitude) {
                                let tglLengkap = formatFullWIB(d.acq_date, d.acq_time);
                                let suhuC = ( (d.bright_ti4 || d.bright_t31) - 273.15).toFixed(1);

                                L.circleMarker([d.latitude, d.longitude], {
                                    radius: 3,
                                    fillColor: "#ff3300",
                                    color: "#fff",
                                    weight: 0.5,
                                    fillOpacity: 0.8
                                }).bindPopup(`
                                    <div style="font-family: sans-serif; min-width: 200px;">
                                        <b style="color:red; font-size:14px;">üî• TITIK API TERDETEKSI</b><br>
                                        <hr style="margin: 5px 0;">
                                        <b>Waktu:</b><br>${tglLengkap}<br>
                                        <b>Suhu:</b> <span style="color:darkred; font-weight:bold;">${suhuC} ¬∞C</span><br>
                                        <b>Satelit:</b> ${satType.toUpperCase()}
                                    </div>
                                `).addTo(dataLayer);
                                total++;
                            }
                        });
                        document.getElementById('details').style.display = "block";
                        document.getElementById('fire-count').innerText = total.toLocaleString();
                        statusEl.innerText = "üü¢ Data Dunia Aktif";
                    }
                });
            } catch (err) { statusEl.innerText = "üî¥ Proxy Terputus"; }
        }

        function zoomToAceh() {
            map.flyTo([4.3, 96.8], 9, { animate: true, duration: 5 });
        }

        window.onload = function() {
            updateData();
            setTimeout(zoomToAceh, 2500);
        };
    </script>
</body>
</html>
