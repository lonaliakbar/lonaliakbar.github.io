<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire Tracker Pro - 4 Satellite Source</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }
        .panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(0,0,0,0.9); color: white; padding: 20px;
            border-radius: 12px; width: 260px; border: 1px solid #444;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        select, button { width: 100%; padding: 10px; margin: 5px 0 12px 0; border-radius: 6px; }
        select { background: #222; color: white; border: 1px solid #555; cursor: pointer; }
        button { background: #d32f2f; color: white; border: none; cursor: pointer; font-weight: bold; }
        .stats { background: rgba(211, 47, 47, 0.15); padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #d32f2f; }
        #fire-count { font-size: 28px; color: #ff4d4d; font-weight: bold; }
        #status { font-size: 11px; color: #888; margin-top: 5px; }
        .leaflet-popup-content-wrapper { background: #1a1a1a; color: #fff; border-radius: 8px; }
    </style>
</head>
<body>

<div class="panel">
    <h2 style="margin:0; color:#ff4d4d;">FIRE TRACKER</h2>
    <p style="font-size: 10px; color:#aaa; margin-bottom:15px;">Auto-Refresh: Aktif (5 Menit)</p>
    
    <label style="font-size:11px; font-weight:bold;">WILAYAH:</label>
    <select id="region-select" onchange="updateData()">
        <option value="aceh">Aceh</option>
        <option value="indonesia">Indonesia</option>
        <option value="dunia">Seluruh Dunia</option>
    </select>

    <label style="font-size:11px; font-weight:bold;">SUMBER SATELIT:</label>
    <select id="sat-source" onchange="updateData()">
        <option value="viirs_snpp">VIIRS SNPP (High Res)</option>
        <option value="modis">MODIS (Aqua/Terra)</option>
        <option value="noaa20">NOAA-20 (J1)</option>
        <option value="noaa21">NOAA-21 (J2)</option>
    </select>

    <div class="stats">
        <div id="fire-count">0</div>
        <div style="font-size:11px; color: #ccc;">Titik Api Terdeteksi</div>
    </div>

    <p id="status">Menginisialisasi...</p>
    <button onclick="clearCacheAndReload()">ðŸ”„ REFRESH SEKARANG</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
    const gasApiUrl = "https://script.google.com/macros/s/AKfycbzZs31kL9CefrJCCE5h6fqluhNwVnSkCfIZ-kc5K62mn85Du1WJpC3BWWZOXzn81C3S/exec"; 

    const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([4.3, 96.8], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    let dataLayer = L.layerGroup().addTo(map);

    function translateSat(code, defaultVal) {
        const list = { "N": "VIIRS (SNPP)", "A": "MODIS (Aqua)", "T": "MODIS (Terra)", "1": "NOAA-20", "2": "NOAA-21" };
        return list[code] || defaultVal.toUpperCase().replace("_", " ");
    }

    function translateConfidence(conf) {
        if (conf === "n") return "Nominal";
        if (conf === "l") return "Rendah (Low)";
        if (conf === "h") return "Tinggi (High)";
        if (!conf) return "Internal";
        return conf + "%";
    }

    function formatWIB(utcDate, utcTime) {
        let tStr = utcTime.toString().padStart(4, '0');
        let d = new Date(utcDate + 'T' + tStr.substring(0, 2) + ':' + tStr.substring(2, 4) + ':00Z');
        d.setHours(d.getHours() + 7);
        return d.toLocaleString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) + " WIB";
    }

    async function updateData() {
        const sat = document.getElementById('sat-source').value;
        const wilayah = document.getElementById('region-select').value;
        const statusBox = document.getElementById('status');
        const cacheKey = `fire_data_${sat}_${wilayah}`;
        const cacheTimeKey = `fire_time_${sat}_${wilayah}`;
        
        dataLayer.clearLayers();
        const now = new Date().getTime();

        const cachedData = localStorage.getItem(cacheKey);
        const cachedTime = localStorage.getItem(cacheTimeKey);

        // Cache 5 menit
        if (cachedData && cachedTime && (now - cachedTime < 300000)) {
            statusBox.innerHTML = "âš¡ Menggunakan Data Cache";
            processCSV(cachedData, sat);
            return;
        }

        statusBox.innerHTML = "â³ Sinkronisasi NASA...";
        try {
            const response = await fetch(`${gasApiUrl}?sat=${sat}&wilayah=${wilayah}`);
            const csvData = await response.text();
            localStorage.setItem(cacheKey, csvData);
            localStorage.setItem(cacheTimeKey, now.toString());
            processCSV(csvData, sat);
            statusBox.innerHTML = "ðŸŸ¢ Data Diperbarui";
        } catch (e) {
            statusBox.innerHTML = "ðŸ”´ Gangguan Koneksi";
        }
    }

    function processCSV(csvData, satType) {
        Papa.parse(csvData, {
            header: true, skipEmptyLines: true, dynamicTyping: true,
            complete: function(res) {
                let total = 0;
                res.data.forEach(d => {
                    if (d.latitude && d.longitude) {
                        let tempC = ((d.bright_ti4 || d.bright_t31 || 300) - 273.15).toFixed(1);
                        let satName = translateSat(d.satellite, satType);
                        let confLabel = translateConfidence(d.confidence);
                        let frp = d.frp || 0;

                        L.circleMarker([d.latitude, d.longitude], {
                            radius: 4, fillColor: frp > 15 ? "#ff0000" : "#ff6600", color: "#fff", weight: 1, fillOpacity: 0.9
                        }).bindPopup(`
                            <div style="min-width: 210px;">
                                <h3 style="margin:0 0 10px 0; color:#ff4d4d; border-bottom:1px solid #444; padding-bottom:5px;">ðŸ”¥ DETAIL HOTSPOT</h3>
                                <table style="width:100%; font-size:12px; border-collapse: collapse;">
                                    <tr><td style="padding:3px 0;"><b>Satelit</b></td><td style="text-align:right">${satName}</td></tr>
                                    <tr><td style="padding:3px 0;"><b>Suhu</b></td><td style="text-align:right; color:#ff4d4d;"><b>${tempC} Â°C</b></td></tr>
                                    <tr><td style="padding:3px 0;"><b>Confidence</b></td><td style="text-align:right"><b>${confLabel}</b></td></tr>
                                    <tr><td style="padding:3px 0;"><b>Energi (FRP)</b></td><td style="text-align:right">${frp} MW</td></tr>
                                    <tr><td style="padding:3px 0;"><b>Waktu WIB</b></td><td style="text-align:right">${formatWIB(d.acq_date, d.acq_time)}</td></tr>
                                    <tr><td style="padding:3px 0;"><b>Koordinat</b></td><td style="text-align:right; font-size:10px;">${d.latitude.toFixed(4)}, ${d.longitude.toFixed(4)}</td></tr>
                                </table>
                            </div>
                        `).addTo(dataLayer);
                        total++;
                    }
                });
                document.getElementById('fire-count').innerText = total.toLocaleString();
                const wilayah = document.getElementById('region-select').value;
                if(wilayah === "aceh") map.flyTo([4.3, 96.8], 8);
                else if(wilayah === "indonesia") map.flyTo([0.78, 113.9], 5);
            }
        });
    }

    function clearCacheAndReload() {
        localStorage.clear();
        updateData();
    }

    setInterval(updateData, 300000); // Auto-refresh 5 menit
    window.onload = updateData;
</script>
</body>
</html>
