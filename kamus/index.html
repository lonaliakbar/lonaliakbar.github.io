<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapitulasi Suara - Real Tally</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Roboto:wght@400;700;900&family=Times+New+Roman&display=swap');
        :root {
            --kpu-red: #e4032a; --kpu-black: #222222; --paper-bg: #f5f5f5;
            --border-color: #cccccc; --text-color: #333333; --success-green: #28a745;
            --invalid-gray: #6c757d;
            --winner-gold: #ffd700; --tie-silver: #c0c0c0;
        }
        html { height: 100%; }
        body {
            height: 100%; margin: 0; overflow: hidden;
            font-family: 'Roboto', sans-serif; background-color: #e0e0e0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #app-wrapper {
            width: 100%; height: 100%;
            max-width: 1800px;
            display: flex; flex-direction: column;
            padding: 0; 
            box-sizing: border-box;
        }
        .page-container {
            width: 100%;
            background-color: var(--paper-bg); border: 3px double var(--kpu-black);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); box-sizing: border-box;
            display: flex; flex-direction: column;
            flex-grow: 1; overflow: hidden;
        }
        header { padding: 12px 25px; border-bottom: 2px solid var(--kpu-black); flex-shrink: 0; background-color: #ffffff; }
        
        footer {
            padding: 8px 20px;
            text-align: center;
            flex-shrink: 0;
            background-color: #fcfcfc;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .footer-actions {
            display: flex;
            gap: 10px;
        }
        .footer-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            color: var(--kpu-black);
            background-color: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .footer-btn:hover {
            background-color: var(--kpu-black);
            border-color: var(--kpu-black);
        }
        .footer-btn svg {
            width: 22px;
            height: 22px;
            stroke: var(--kpu-black);
            transition: stroke 0.3s;
        }
        .footer-btn:hover svg {
            stroke: white;
        }
        .footer-credit {
            margin: 0;
            font-size: 0.8rem;
            color: #888888;
            font-weight: 500;
        }

        #reset-all-btn:hover {
            background-color: #fce8e8;
            border-color: var(--kpu-red);
        }
        #reset-all-btn:hover svg {
            stroke: var(--kpu-red);
        }

        .header-top { display: flex; align-items: center; }
        .logo { height: 50px; width: 50px; margin-right: 15px; flex-shrink: 0; }
        .header-text { text-align: left; flex-grow: 1; }
        .main-title { font-family: 'Times New Roman', serif; margin: 0; font-weight: 700; font-size: clamp(1.4rem, 2.2vw, 2rem); }
        .subtitle { color: #666; margin: 0; font-size: clamp(0.9rem, 1.5vw, 1.1rem); }
        [contenteditable="true"] { -webkit-user-select: text; user-select: text; }
        [contenteditable="true"]:focus, [contenteditable="true"]:hover { background-color: #fffde7; outline: 1px dashed var(--kpu-red); border-radius: 3px; }
        .summary-panel { display: flex; justify-content: space-around; flex-wrap: wrap; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color); }
        .summary-item { text-align: center; padding: 5px 10px; flex-basis: 22%; min-width: 150px;}
        .summary-label { font-size: 0.85rem; }
        .summary-value { font-size: clamp(1.8rem, 2.5vw, 2.2rem); font-weight: 900; line-height: 1.2; margin-top: 5px; color: var(--kpu-black); }
        #total-voters { color: var(--kpu-red); padding: 0 10px; border-radius: 5px; cursor: pointer; }

        .ballot-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 15px;
            align-content: start;
        }

        .candidate-entry { display: flex; align-items: stretch; border: 3px solid transparent; border-radius: 5px; background-color: #ffffff; transition: all 0.3s; }
        .candidate-entry:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .candidate-number { font-size: clamp(2rem, 3vw, 2.5rem); font-weight: 700; color: var(--kpu-red); padding: 0 25px; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--border-color); background-color: #fafafa; }
        .candidate-entry.invalid-votes .candidate-number { color: var(--invalid-gray); }
        .candidate-entry.invalid-votes .tally-five-group::after { background-color: var(--invalid-gray); }
        .candidate-info { padding: 15px; flex-grow: 1; overflow: hidden;}
        .candidate-name { font-size: clamp(1.2rem, 1.8vw, 1.5rem); font-weight: 700; margin: 0 0 10px 0; }
        .tally-display { font-family: 'Architects Daughter', cursive; color: #444; font-size: clamp(1.8rem, 2.5vw, 2.2rem); word-break: break-all; letter-spacing: 2px; min-height: 40px; }
        .tally-five-group { position: relative; display: inline-block; padding: 0 8px 0 2px; color: #333; }
        .tally-five-group::after { content: ''; position: absolute; top: 50%; left: -5%; width: 110%; height: 4px; background-color: var(--kpu-red); transform: rotate(-15deg); border-radius: 2px; }
        .vote-controls { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; border-left: 1px solid var(--border-color); gap: 10px; }
        .vote-count { font-size: clamp(2rem, 3vw, 2.5rem); font-weight: 700; color: var(--kpu-black); }
        .winner-highlight { border: 3px solid var(--winner-gold); box-shadow: 0 0 15px var(--winner-gold); }
        .tie-highlight { border: 3px solid var(--tie-silver); box-shadow: 0 0 15px var(--tie-silver); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.4); width: 90%; max-width: 700px; text-align: center; animation: slideIn 0.4s ease-out; }
        .modal-header { position: relative; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--kpu-black); font-family: 'Times New Roman', serif; }
        .close-btn { position: absolute; top: -15px; right: -10px; font-size: 2.5rem; font-weight: bold; color: #aaa; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--kpu-red); }
        .winner-title { font-size: 1.2rem; font-weight: 700; color: var(--invalid-gray); text-transform: uppercase; }
        .winner-name { font-size: 2.5rem; font-weight: 900; color: var(--kpu-red); margin: 10px 0; }
        .winner-stats { font-size: 1rem; color: #555; margin-bottom: 25px; }
        #full-results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #full-results-table th, #full-results-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        #full-results-table th { background-color: #f8f8f8; font-weight: 700; }
        #full-results-table td:nth-child(2), #full-results-table td:nth-child(3) { text-align: right; font-weight: bold; }
        .modal-footer { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .modal-footer .footer-btn { font-size: 0.9rem; padding: 10px 25px; border-radius: 5px; border: 1px solid var(--kpu-black); color: var(--kpu-black); background-color: transparent; font-weight: 700; cursor: pointer; margin: 5px; transition: all 0.3s; width: auto; height: auto;}
        .modal-footer .footer-btn:hover { background-color: var(--kpu-black); color: white; }
        
        #custom-dialog-overlay { background: rgba(0, 0, 0, 0.6); z-index: 2000; }
        #custom-dialog-box .modal-footer .footer-btn { font-weight: 500; }
        #custom-dialog-box .modal-footer .btn-danger { background-color: var(--kpu-red); border-color: var(--kpu-red); color: white; }
        #custom-dialog-box .modal-footer .btn-danger:hover { background-color: #c80022; border-color: #c80022; }
        #custom-dialog-box #dialog-input { transition: border-color 0.3s, box-shadow 0.3s; }
        #custom-dialog-box #dialog-input:focus { outline: none; border-color: var(--kpu-red); box-shadow: 0 0 5px rgba(228, 3, 42, 0.4); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { translateY(0); opacity: 1; } }
        @media print { body > *:not(.printable-area) { display: none !important; } .printable-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; } }
        @media (max-width: 900px) { .ballot-area { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { #app-wrapper { padding: 5px; } .summary-item { flex-basis: 45%; } .header-top { flex-direction: column; text-align: center; } .header-text { margin-top: 10px; } footer { flex-direction: column; gap: 8px; } }
        @media (max-width: 480px) { .candidate-entry { flex-direction: column; } .vote-controls { border-left: none; border-top: 1px solid var(--border-color); padding-top: 15px; } .candidate-number { border-right: none; padding: 10px; } .main-title { font-size: clamp(1.2rem, 5vw, 1.4rem); } .subtitle { font-size: clamp(0.8rem, 3vw, 0.9rem); } .ballot-area { padding: 10px; gap: 10px; grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <div class="page-container">
            <header id="header">
                 <div class="header-top">
                    <svg class="logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Ikon Pemungutan Suara"><path d="M7 12L10 15L17 8" stroke="var(--kpu-red)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 4H20V16C20 17.1046 19.1046 18 18 18H6C4.89543 18 4 17.1046 4 16V4Z" stroke="var(--kpu-black)" stroke-width="2"/><path d="M9 4V2" stroke="var(--kpu-black)" stroke-width="2" stroke-linecap="round"/><path d="M15 4V2" stroke="var(--kpu-black)" stroke-width="2" stroke-linecap="round"/><path d="M4 20H20" stroke="var(--kpu-black)" stroke-width="2" stroke-linecap="round"/></svg>
                    <div class="header-text">
                        <h1 id="main-title" class="main-title" contenteditable="true">REKAPITULASI HASIL PENGHITUNGAN SUARA</h1>
                        <p id="subtitle" class="subtitle" contenteditable="true">PEMILIHAN UMUM TAHUN 2025</p>
                    </div>
                </div>
                <div class="summary-panel">
                    <div class="summary-item"><div class="summary-label">JUMLAH PEMILIH (DPT)</div><div id="total-voters" class="summary-value" contenteditable="true" title="Klik untuk mengubah">100</div></div>
                    <div class="summary-item"><div class="summary-label">TOTAL SUARA MASUK</div><div id="total-votes-cast" class="summary-value">0</div></div>
                    <div class="summary-item"><div class="summary-label">SUARA TIDAK SAH</div><div id="invalid-votes-summary" class="summary-value" style="color: var(--invalid-gray);">0</div></div>
                    <div class="summary-item"><div class="summary-label">SISA SUARA</div><div id="remaining-votes" class="summary-value">100</div></div>
                </div>
            </header>
            <main id="ballot-area" class="ballot-area"></main>
        </div>
        <footer id="footer">
            <p class="footer-credit">Developed by Ali Akbar</p>
            <div class="footer-actions">
                <button id="add-candidate-btn" class="footer-btn" title="Tambah Calon/Opsi">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                </button>
                <button id="reset-votes-btn" class="footer-btn" title="Reset Semua Suara">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0m0 0a8.25 8.25 0 0 0-11.667 0l3.181 3.183" />
                    </svg>
                </button>
                <button id="reset-all-btn" class="footer-btn" title="Reset Semua Data (Aplikasi)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <div id="results-modal" class="modal-overlay">
        <div id="modal-content" class="modal-content">
             <div class="modal-header"><h2>HASIL AKHIR PENGHITUNGAN SUARA</h2><span id="close-modal-btn" class="close-btn">&times;</span></div>
            <div class="modal-body">
                <div id="winner-announcement"><div id="winner-title" class="winner-title"></div><div id="winner-name" class="winner-name"></div><div class="winner-stats">Memperoleh <strong id="winner-votes">0</strong> Suara (<strong id="winner-percentage">0.0%</strong>)</div></div>
                <h3 style="margin: 30px 0 10px 0; text-align: left; color: #333;">Rincian Lengkap:</h3>
                <div id="full-results-table"></div>
            </div>
            <div class="modal-footer"><button id="print-results-btn" class="footer-btn">🖨️ Cetak Hasil</button><button id="download-image-btn" class="footer-btn">🖼️ Unduh sebagai Gambar</button></div>
        </div>
    </div>

    <div id="custom-dialog-overlay" class="modal-overlay">
        <div id="custom-dialog-box" class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="dialog-title">Judul Dialog</h2>
            </div>
            <div class="modal-body" style="padding: 20px 0;">
                <p id="dialog-message" style="margin-bottom: 20px; font-size: 1rem; color: #333;"></p>
                <input type="text" id="dialog-input" placeholder="Masukkan di sini..." style="display: none; width: 95%; padding: 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            <div id="dialog-buttons" class="modal-footer" style="justify-content: flex-end;">
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const ballotArea = document.getElementById('ballot-area');
        const addCandidateBtn = document.getElementById('add-candidate-btn');
        const resetVotesBtn = document.getElementById('reset-votes-btn');
        const resetAllBtn = document.getElementById('reset-all-btn');
        const mainTitleEl = document.getElementById('main-title');
        const subtitleEl = document.getElementById('subtitle');
        const totalVotersEl = document.getElementById('total-voters');
        const totalVotesCastEl = document.getElementById('total-votes-cast');
        const remainingVotesEl = document.getElementById('remaining-votes');
        const invalidVotesSummaryEl = document.getElementById('invalid-votes-summary');
        const modal = document.getElementById('results-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const printBtn = document.getElementById('print-results-btn');
        const downloadBtn = document.getElementById('download-image-btn');
        let candidates = [];
        let invalidVotes = 0;
        let finalResultsAnnounced = false;

        const speakVote = (text) => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID'; 
                utterance.rate = 1.2; 
                utterance.pitch = 1.2;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            }
        };
        
        const showDialog = (type, title, message, options = {}) => {
            return new Promise((resolve) => {
                const { placeholder = '', confirmText = 'OK' } = options;
                const overlay = document.getElementById('custom-dialog-overlay');
                const dialogTitle = document.getElementById('dialog-title');
                const dialogMessage = document.getElementById('dialog-message');
                const dialogInput = document.getElementById('dialog-input');
                const dialogButtons = document.getElementById('dialog-buttons');

                dialogTitle.innerHTML = title;
                dialogMessage.textContent = message;
                dialogButtons.innerHTML = '';

                const createButton = (text, className, value) => {
                    const button = document.createElement('button');
                    button.textContent = text;
                    button.className = `footer-btn ${className}`;
                    button.onclick = () => {
                        overlay.style.display = 'none';
                        resolve(value);
                    };
                    return button;
                };

                const cancelBtn = createButton('Batalkan', 'btn-secondary', false);

                if (type === 'confirm') {
                    dialogInput.style.display = 'none';
                    const confirmBtn = createButton(confirmText, 'btn-danger', true);
                    dialogButtons.appendChild(cancelBtn);
                    dialogButtons.appendChild(confirmBtn);
                } else if (type === 'prompt') {
                    dialogInput.style.display = 'block';
                    dialogInput.value = '';
                    dialogInput.placeholder = placeholder;
                    const saveBtn = createButton('Simpan', 'btn-primary', true);
                    dialogButtons.appendChild(cancelBtn);
                    dialogButtons.appendChild(saveBtn);

                    saveBtn.onclick = () => {
                        overlay.style.display = 'none';
                        resolve(dialogInput.value);
                    };
                    dialogInput.onkeydown = (e) => {
                        if (e.key === 'Enter') saveBtn.click();
                    };
                }

                overlay.style.display = 'flex';
                if (type === 'prompt') setTimeout(() => dialogInput.focus(), 100);
            });
        };

        const handleKeyPress = (e) => {
            if (e.target.isContentEditable && e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
                return;
            }
            
            if (e.target.isContentEditable || document.getElementById('custom-dialog-overlay').style.display === 'flex') return;
            if (!/^[0-9]$/.test(e.key)) return;
            e.preventDefault();
            const remainingVotes = parseInt(remainingVotesEl.textContent) || 0;
            if (remainingVotes <= 0) {
                const totalVotesEl = document.getElementById('total-votes-cast');
                totalVotesEl.style.transform = 'scale(1.1)';
                totalVotesEl.style.color = 'var(--kpu-red)';
                setTimeout(() => {
                    totalVotesEl.style.transform = 'scale(1)';
                    totalVotesEl.style.color = '';
                }, 200);
                return;
            }
            const num = parseInt(e.key);
            if (num === 0) {
                invalidVotes++;
                speakVote("Suara tidak sah!"); 
            } else {
                if (candidates[num - 1]) {
                    candidates[num - 1].votes++;
                    const candidateName = candidates[num - 1].name;
                    speakVote(`${num}, ${candidateName}!`);
                } else {
                    return;
                }
            }
            saveState();
            renderAll();
        };

        const saveState = () => {
            const state = { candidates, invalidVotes, title: mainTitleEl.textContent, subtitle: subtitleEl.textContent, totalVoters: parseInt(totalVotersEl.textContent) || 0 };
            localStorage.setItem('kpuTallyState', JSON.stringify(state));
        };
        
        const loadDefaultData = () => {
            mainTitleEl.textContent = 'REKAPITULASI HASIL PENGHITUNGAN SUARA';
            subtitleEl.textContent = 'PEMILIHAN UMUM TAHUN 2025';
            totalVotersEl.textContent = '0'; // DPT juga direset ke 0
            candidates = [
                { id: Date.now(), name: 'CALON NOMOR URUT SATU', votes: 0 },
                { id: Date.now() + 1, name: 'CALON NOMOR URUT DUA', votes: 0 }
            ];
            invalidVotes = 0;
            finalResultsAnnounced = false;
            resetHighlights();
        };

        const loadState = () => {
            const savedState = localStorage.getItem('kpuTallyState');
            if (savedState) {
                const state = JSON.parse(savedState);
                candidates = state.candidates || [];
                invalidVotes = state.invalidVotes || 0;
                mainTitleEl.textContent = state.title || 'REKAPITULASI HASIL PENGHITUNGAN SUARA';
                subtitleEl.textContent = state.subtitle || 'PEMILIHAN UMUM TAHUN 2025';
                totalVotersEl.textContent = state.totalVoters || 0;
            } else {
                loadDefaultData();
            }
            renderAll();
        };

        const updateSummary = () => {
            const totalVoters = parseInt(totalVotersEl.textContent) || 0;
            const totalValidVotes = candidates.reduce((sum, candidate) => sum + candidate.votes, 0);
            const totalVotesCast = totalValidVotes + invalidVotes;
            const remainingVotes = totalVoters - totalVotesCast;
            totalVotesCastEl.textContent = totalVotesCast;
            invalidVotesSummaryEl.textContent = invalidVotes;
            remainingVotesEl.textContent = remainingVotes;
            if (remainingVotes <= 0 && !finalResultsAnnounced && totalVotesCast > 0) {
                triggerFinalAnnouncement();
            }
        };

        const generateTallyHTML = (count) => {
            if (count === 0) return '<span style="font-family: Roboto, sans-serif; font-size: 1rem; color: #aaa;">Belum ada suara</span>';
            let html = '';
            const fullGroups = Math.floor(count / 5);
            const remainder = count % 5;
            for (let i = 0; i < fullGroups; i++) { html += '<span class="tally-five-group">||||</span>'; }
            if (remainder > 0) { html += '|'.repeat(remainder); }
            return html;
        };

        const renderAll = () => {
            ballotArea.innerHTML = '';
            candidates.forEach((candidate, index) => {
                const entry = document.createElement('div');
                entry.className = 'candidate-entry';
                entry.setAttribute('data-id', candidate.id);
                entry.innerHTML = `<div class="candidate-number">${index + 1}</div><div class="candidate-info"><h2 class="candidate-name" contenteditable="true">${candidate.name}</h2><div class="tally-display">${generateTallyHTML(candidate.votes)}</div></div><div class="vote-controls"><div class="vote-count">${candidate.votes}</div></div>`;
                ballotArea.appendChild(entry);
            });
            const invalidEntry = document.createElement('div');
            invalidEntry.className = 'candidate-entry invalid-votes';
            invalidEntry.id = 'invalid-votes-entry';
            invalidEntry.innerHTML = `<div class="candidate-number">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="48" height="48">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m.75 12 3 3m0 0 3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                </svg>
            </div><div class="candidate-info"><h2 class="candidate-name">SUARA TIDAK SAH / RUSAK</h2><div class="tally-display">${generateTallyHTML(invalidVotes)}</div></div><div class="vote-controls"><div class="vote-count">${invalidVotes}</div></div>`;
            ballotArea.appendChild(invalidEntry);
            updateSummary();
        };

        const getWinnerInfo = () => {
            const totalValidVotes = candidates.reduce((sum, c) => sum + c.votes, 0);
            if (candidates.length === 0 || totalValidVotes === 0) { return { title: 'HASIL AKHIR', names: 'Tidak ada suara sah', winners: [], votes: 0, percentage: 0 }; }
            const maxVotes = Math.max(...candidates.map(c => c.votes));
            if (maxVotes === 0) { return { title: 'HASIL AKHIR', names: 'Tidak ada suara sah', winners: [], votes: 0, percentage: 0 }; }
            const winners = candidates.filter(c => c.votes === maxVotes);
            const percentage = ((maxVotes / totalValidVotes) * 100).toFixed(1);
            if (winners.length === 1) { return { title: 'PEMENANG', names: winners[0].name.toUpperCase(), winners, votes: maxVotes, percentage }; }
             else { return { title: 'HASIL SERI', names: winners.map(w => w.name.toUpperCase()).join(' & '), winners, votes: maxVotes, percentage }; }
        };

        const triggerFinalAnnouncement = () => {
            finalResultsAnnounced = true;
            const result = getWinnerInfo();
            document.getElementById('winner-title').textContent = result.title;
            document.getElementById('winner-name').textContent = result.names;
            document.getElementById('winner-votes').textContent = result.votes;
            document.getElementById('winner-percentage').textContent = result.percentage + '% dari suara sah';
            const totalValidVotes = candidates.reduce((sum, c) => sum + c.votes, 0);
            let tableHTML = '<table id="full-results-table"><thead><tr><th>Nama Calon/Opsi</th><th>Suara</th><th>Persentase</th></tr></thead><tbody>';
            candidates.forEach(c => {
                const perc = totalValidVotes > 0 ? ((c.votes / totalValidVotes) * 100).toFixed(1) + '%' : '0.0%';
                tableHTML += `<tr><td>${c.name}</td><td>${c.votes}</td><td>${perc}</td></tr>`;
            });
            tableHTML += '</tbody></table>';
            document.getElementById('full-results-table').innerHTML = tableHTML;
            highlightWinnersInList(result.winners, result.title);
            modal.style.display = 'flex';
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        };

        const highlightWinnersInList = (winners, title) => {
            const highlightClass = title === 'PEMENANG' ? 'winner-highlight' : 'tie-highlight';
            const winnerIds = winners.map(w => w.id);
            document.querySelectorAll('.candidate-entry[data-id]').forEach(entry => {
                if (winnerIds.includes(Number(entry.dataset.id))) { entry.classList.add(highlightClass); }
            });
        };
        const resetHighlights = () => { document.querySelectorAll('.winner-highlight, .tie-highlight').forEach(el => { el.classList.remove('winner-highlight', 'tie-highlight'); }); };
        
        const handleTextChange = (e) => {
            const target = e.target;
            if (target.classList.contains('candidate-name')) {
                const id = Number(target.closest('.candidate-entry').getAttribute('data-id'));
                const candidate = candidates.find(c => c.id === id);
                if (candidate && candidate.name !== target.textContent) {
                    candidate.name = target.textContent;
                    saveState();
                }
            }
        };

        const addNewCandidate = async () => {
            const name = await showDialog(
                'prompt',
                '➕ Tambah Opsi/Calon Baru',
                'Masukkan nama calon atau opsi yang akan ditambahkan ke dalam daftar.',
                { placeholder: `CALON ${candidates.length + 1}` }
            );
            if (name && name.trim() !== '') {
                candidates.push({ id: Date.now(), name: name.trim().toUpperCase(), votes: 0 });
                saveState();
                renderAll();
            }
        };

        const resetVotes = async () => {
            const confirmed = await showDialog(
                'confirm',
                '⚠️ Konfirmasi Reset Suara',
                'Anda yakin ingin mengatur ulang semua perolehan suara ke nol? Nama calon dan judul akan tetap ada. Tindakan ini tidak dapat dibatalkan.',
                { confirmText: 'Ya, Reset Suara' }
            );
            if (confirmed) {
                candidates.forEach(c => c.votes = 0);
                invalidVotes = 0;
                finalResultsAnnounced = false;
                resetHighlights();
                saveState();
                renderAll();
            }
        };

        const resetAll = async () => {
            const confirmed = await showDialog(
                'confirm',
                '🛑 Reset Aplikasi ke Awal?',
                'Anda akan mereset SEMUA data termasuk judul, nama calon, suara, dan Jumlah Pemilih (DPT) ke kondisi awal. Lanjutkan?',
                { confirmText: 'Ya, Reset Semua' }
            );
            if (confirmed) {
                localStorage.removeItem('kpuTallyState');
                loadDefaultData();
                saveState();
                renderAll();
            }
        };

        // --- EVENT LISTENERS ---
        document.addEventListener('keydown', handleKeyPress);
        ballotArea.addEventListener('input', handleTextChange);
        mainTitleEl.addEventListener('focusout', saveState);
        subtitleEl.addEventListener('focusout', saveState);
        totalVotersEl.addEventListener('focusout', () => { updateSummary(); saveState(); });
        totalVotersEl.addEventListener('dragstart', (e) => e.preventDefault());
        addCandidateBtn.addEventListener('click', addNewCandidate);
        resetVotesBtn.addEventListener('click', resetVotes);
        resetAllBtn.addEventListener('click', resetAll);
        closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
        downloadBtn.addEventListener('click', () => {
            const modalContent = document.getElementById('modal-content');
            html2canvas(modalContent, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `hasil-akhir-${mainTitleEl.textContent.toLowerCase().replace(/\s/g, '_')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        });
        printBtn.addEventListener('click', () => {
            const modalContent = document.getElementById('modal-content');
            const printableArea = document.createElement('div');
            printableArea.classList.add('printable-area');
            printableArea.appendChild(modalContent.cloneNode(true));
            document.body.appendChild(printableArea);
            window.print();
            document.body.removeChild(printableArea);
        });

        loadState();
    });
    </script>
</body>
</html>
