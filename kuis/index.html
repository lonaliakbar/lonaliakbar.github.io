<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BrainSpark AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. DESIGN SYSTEM (Startup Style) --- */
        :root {
            --primary: #6366f1; /* Indigo */
            --primary-dark: #4338ca;
            --secondary: #ec4899; /* Pink */
            --accent: #8b5cf6; /* Purple */
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gradient-main: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --glass: rgba(30, 41, 59, 0.7);
            --border: rgba(255,255,255,0.08);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden;
            display: flex; justify-content: center;
        }

        /* --- 2. LAYOUT ENGINE --- */
        #app-container {
            width: 100%; max-width: 480px; height: 100%; position: relative;
            background: #0f172a; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Background Effects */
        .ambient-glow {
            position: absolute; width: 300px; height: 300px; background: var(--primary);
            filter: blur(120px); opacity: 0.15; border-radius: 50%; pointer-events: none; z-index: 0;
        }
        .glow-1 { top: -50px; left: -50px; animation: float 10s infinite alternate; }
        .glow-2 { bottom: -50px; right: -50px; background: var(--secondary); animation: float 8s infinite alternate-reverse; }

        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px, 50px); } }

        /* Screens Manager */
        .view {
            position: absolute; inset: 0; padding: 20px; padding-bottom: 90px; /* Space for nav */
            display: flex; flex-direction: column; opacity: 0; pointer-events: none;
            transform: scale(0.95); transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow-y: auto; z-index: 10;
        }
        .view.active { opacity: 1; pointer-events: all; transform: scale(1); visibility: visible; }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; right: 0; height: 80px;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border); display: flex; justify-content: space-around;
            align-items: center; padding-bottom: 10px; z-index: 50;
        }
        .nav-item {
            color: var(--text-muted); text-align: center; font-size: 0.75rem;
            cursor: pointer; transition: 0.2s; width: 60px;
        }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; display: block; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); color: var(--accent); }

        /* --- 3. COMPONENTS --- */
        /* Header Stats */
        .top-stats { display: flex; gap: 10px; margin-bottom: 20px; z-index: 20; position: relative; }
        .stat-pill {
            background: var(--glass); border: 1px solid var(--border); padding: 6px 12px;
            border-radius: 50px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;
        }
        .stat-energy { color: var(--warning); border-color: rgba(245, 158, 11, 0.3); }
        .stat-gem { color: var(--secondary); border-color: rgba(236, 72, 153, 0.3); }
        .stat-xp { flex-grow: 1; justify-content: center; background: #334155; height: 34px; position: relative; overflow: hidden; }
        .xp-fill { position: absolute; left: 0; top: 0; bottom: 0; background: var(--gradient-main); width: 0%; transition: 1s; }
        .xp-text { position: relative; z-index: 2; font-size: 0.7rem; color: white; }

        /* Cards */
        .card { background: var(--bg-card); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border); }
        .card-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* Game Mode Select */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .mode-card {
            background: linear-gradient(160deg, #1e293b, #0f172a); border: 1px solid var(--border);
            border-radius: 18px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;
            position: relative; overflow: hidden;
        }
        .mode-card:active { transform: scale(0.95); }
        .mode-card i { font-size: 2rem; margin-bottom: 10px; background: -webkit-linear-gradient(#eee, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .mode-card.locked { opacity: 0.5; filter: grayscale(1); }
        .lock-icon { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.5); color: white; font-size: 1.5rem; }

        /* Game Screen */
        .timer-bar { width: 100%; height: 6px; background: #334155; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
        .timer-fill { height: 100%; background: var(--success); width: 100%; transition: width 1s linear; }
        
        .question-text { font-size: 1.3rem; font-weight: 700; text-align: center; margin: 20px 0 40px 0; line-height: 1.4; min-height: 80px; }
        
        .opt-btn {
            width: 100%; padding: 18px; margin-bottom: 12px; border-radius: 16px; border: 1px solid var(--border);
            background: rgba(255,255,255,0.03); color: white; text-align: left; font-size: 1rem; font-weight: 500;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 15px;
        }
        .opt-btn:active { background: rgba(255,255,255,0.1); transform: scale(0.98); }
        .opt-btn.correct { background: var(--success); border-color: var(--success); color: #000; }
        .opt-btn.wrong { background: var(--danger); border-color: var(--danger); animation: shake 0.4s; }
        
        .opt-key { width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; }

        /* Leaderboard */
        .rank-row { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: var(--bg-card); border-radius: 12px; }
        .rank-num { font-weight: 900; width: 30px; color: var(--text-muted); font-style: italic; }
        .rank-avatar { width: 35px; height: 35px; border-radius: 50%; background: #333; margin-right: 12px; display: flex; align-items: center; justify-content: center; }
        .rank-score { margin-left: auto; font-weight: bold; color: var(--primary); }

        /* Gacha/Shop */
        .chest-box { width: 150px; height: 120px; margin: 0 auto; background: url('https://cdn-icons-png.flaticon.com/512/2903/2903558.png') center/contain no-repeat; cursor: pointer; transition: 0.2s; }
        .chest-box:active { transform: scale(0.9); }
        
        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #1e293b; width: 85%; padding: 25px; border-radius: 24px;
            text-align: center; border: 1px solid var(--border); transform: translateY(20px); transition: 0.3s;
        }
        .modal-overlay.open .modal-content { transform: translateY(0); }

        .btn-primary {
            background: var(--gradient-main); border: none; padding: 14px; width: 100%; border-radius: 12px;
            color: white; font-weight: bold; font-size: 1rem; margin-top: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        .hide { display: none !important; }

    </style>
</head>
<body>

<div id="app-container">
    <div class="ambient-glow glow-1"></div>
    <div class="ambient-glow glow-2"></div>

    <div id="view-home" class="view active">
        <div class="top-stats">
            <div class="stat-pill stat-energy"><i class="fas fa-bolt"></i> <span id="val-energy">10/10</span></div>
            <div class="stat-pill stat-gem"><i class="fas fa-gem"></i> <span id="val-gems">0</span></div>
            <div class="stat-pill stat-xp">
                <div class="xp-fill" id="xp-bar" style="width: 20%"></div>
                <div class="xp-text">LVL <span id="val-lvl">1</span></div>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <h1 style="font-size: 1.8rem;">Hi, <span id="user-name">Player</span>! üëã</h1>
            <p style="color:var(--text-muted)">Siap mengasah otakmu hari ini?</p>
        </div>

        <div class="card" style="background: linear-gradient(to right, #3730a3, #4c1d95); border:none;" id="daily-card">
            <div class="card-title" style="color:#fff">üéÅ Daily Login <span style="font-size:0.8rem; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:10px;">READY</span></div>
            <p style="font-size:0.9rem; opacity:0.8; margin-bottom:10px;">Klaim hadiah harianmu sekarang!</p>
            <button onclick="App.claimDaily()" style="background:white; color:#4c1d95; border:none; padding:8px 20px; border-radius:50px; font-weight:bold; font-size:0.8rem;">Klaim +50 Gems</button>
        </div>

        <h3 style="margin-bottom:15px;">Game Mode</h3>
        <div class="mode-grid">
            <div class="mode-card" onclick="Game.start('general')">
                <i class="fas fa-globe"></i>
                <h3>General</h3>
                <p style="font-size:0.7rem; color:var(--text-muted)">Pengetahuan Umum</p>
            </div>
            <div class="mode-card" onclick="Game.start('science')">
                <i class="fas fa-atom"></i>
                <h3>Science</h3>
                <p style="font-size:0.7rem; color:var(--text-muted)">Sains & Alam</p>
            </div>
            <div class="mode-card" onclick="Game.start('computer')">
                <i class="fas fa-laptop-code"></i>
                <h3>Tech</h3>
                <p style="font-size:0.7rem; color:var(--text-muted)">Komputer & IT</p>
            </div>
            <div class="mode-card locked">
                <i class="fas fa-skull"></i>
                <h3>Hardcore</h3>
                <div class="lock-icon"><i class="fas fa-lock"></i></div>
            </div>
        </div>
    </div>

    <div id="view-game" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <button onclick="App.router('home')" style="background:none; border:none; color:white; font-size:1.2rem;"><i class="fas fa-arrow-left"></i></button>
            <div style="font-weight:bold; color:var(--primary);">SCORE: <span id="game-score">0</span></div>
            <button id="voice-trigger" onclick="Voice.toggle()" style="width:35px; height:35px; border-radius:50%; background:rgba(255,255,255,0.1); border:none; color:white;"><i class="fas fa-microphone"></i></button>
        </div>

        <div class="timer-bar"><div class="timer-fill" id="timer-bar"></div></div>
        
        <div id="game-loader" style="text-align:center; padding:50px;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:2rem; color:var(--primary)"></i>
            <p style="margin-top:10px; font-size:0.9rem;">Fetching Data...</p>
        </div>

        <div id="game-content" class="hide">
            <div class="question-text" id="q-text">Pertanyaan akan muncul di sini...</div>
            <div id="options-container">
                </div>
        </div>
    </div>

    <div id="view-shop" class="view">
        <h2 style="margin-bottom:20px;">Shop & Gacha</h2>
        
        <div class="card" style="text-align:center;">
            <div class="chest-box" onclick="Shop.openChest()"></div>
            <h3>Mystery Chest</h3>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:10px;">Cost: 100 Gems</p>
            <button class="btn-primary" onclick="Shop.openChest()">Open Chest</button>
        </div>

        <div class="card">
            <div class="card-title">Stamina Refill</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div><i class="fas fa-bolt" style="color:var(--warning)"></i> +5 Energy</div>
                <button style="background:rgba(255,255,255,0.1); border:1px solid var(--border); color:white; padding:5px 15px; border-radius:8px;" onclick="Shop.buyEnergy()">50 Gems</button>
            </div>
        </div>
    </div>

    <div id="view-leaderboard" class="view">
        <h2 style="margin-bottom:20px;">Global Top 10</h2>
        <div id="lb-list">
            </div>
    </div>

    <div id="view-profile" class="view">
        <div style="text-align:center; margin-bottom:30px; margin-top:20px;">
            <div style="width:100px; height:100px; background:var(--gradient-main); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:3rem;">üòé</div>
            <h2 id="profile-name">Guest</h2>
            <div style="color:var(--primary); font-weight:bold; margin-top:5px;" id="profile-rank">Novice</div>
        </div>

        <div class="card">
            <div class="card-title">Statistics</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; text-align:center;">
                <div>
                    <div style="font-size:1.5rem; font-weight:bold;" id="stat-games">0</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">Games Played</div>
                </div>
                <div>
                    <div style="font-size:1.5rem; font-weight:bold; color:var(--success);" id="stat-high">0</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">High Score</div>
                </div>
            </div>
        </div>

        <button class="btn-primary" style="background:#ef4444;" onclick="User.reset()">Reset All Data</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="App.router('home')">
            <i class="fas fa-home"></i> Home
        </div>
        <div class="nav-item" onclick="App.router('shop')">
            <i class="fas fa-store"></i> Shop
        </div>
        <div class="nav-item" onclick="App.router('leaderboard')">
            <i class="fas fa-trophy"></i> Rank
        </div>
        <div class="nav-item" onclick="App.router('profile')">
            <i class="fas fa-user"></i> Me
        </div>
    </div>

    <div id="modal-reward" class="modal-overlay">
        <div class="modal-content">
            <div style="font-size:3rem; margin-bottom:10px;">üíé</div>
            <h2>Reward!</h2>
            <p id="reward-msg">You got 50 Gems</p>
            <button class="btn-primary" onclick="document.getElementById('modal-reward').classList.remove('open')">Awesome</button>
        </div>
    </div>

</div>

<script>
/**
 * BRAINSPARK AI ENGINE
 * Architecture: Singleton Modules (User, App, Game, Shop, Voice)
 */

/* --- 1. USER & DATA MANAGER --- */
const User = {
    data: {
        name: "Guest",
        xp: 0,
        level: 1,
        gems: 100,
        energy: 10,
        lastLogin: null,
        stats: { games: 0, highScore: 0 }
    },

    init() {
        const saved = localStorage.getItem('brainspark_save');
        if (saved) this.data = JSON.parse(saved);
        else {
            let name = prompt("Siapa nama kamu?", "SmartUser");
            if(name) this.data.name = name;
        }
        this.checkEnergyRegen();
        this.save();
        this.updateUI();
    },

    save() {
        localStorage.setItem('brainspark_save', JSON.stringify(this.data));
        this.updateUI();
    },

    checkEnergyRegen() {
        // Simple logic: Reset energy if new day (simplified for demo)
        if(this.data.energy < 10) {
            // In real app, check timestamps. Here we just give +1 on reload for fun
            this.data.energy = Math.min(10, this.data.energy + 1); 
        }
    },

    addXP(amount) {
        this.data.xp += amount;
        const req = this.data.level * 100;
        if (this.data.xp >= req) {
            this.data.xp -= req;
            this.data.level++;
            App.showModal("Level Up!", `Selamat! Kamu naik ke Level ${this.data.level}`);
            this.data.gems += 20; // Level up reward
        }
        this.save();
    },

    updateUI() {
        document.getElementById('val-energy').innerText = `${this.data.energy}/10`;
        document.getElementById('val-gems').innerText = this.data.gems;
        document.getElementById('val-lvl').innerText = this.data.level;
        document.getElementById('user-name').innerText = this.data.name;
        document.getElementById('profile-name').innerText = this.data.name;
        document.getElementById('stat-games').innerText = this.data.stats.games;
        document.getElementById('stat-high').innerText = this.data.stats.highScore;
        
        // XP Bar
        const pct = (this.data.xp / (this.data.level * 100)) * 100;
        document.getElementById('xp-bar').style.width = `${pct}%`;

        // Rank Logic
        let rank = "Novice";
        if(this.data.level >= 5) rank = "Apprentice";
        if(this.data.level >= 10) rank = "Expert";
        if(this.data.level >= 20) rank = "Master";
        document.getElementById('profile-rank').innerText = rank;
    },

    reset() {
        if(confirm("Reset semua progress?")) {
            localStorage.clear();
            location.reload();
        }
    }
};

/* --- 2. APP CONTROLLER (Routing & UI) --- */
const App = {
    init() {
        User.init();
        this.checkDaily();
        this.router('home');
        this.generateLeaderboard();
    },

    router(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewId}`).classList.add('active');
        
        // Nav Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(viewId === 'home') document.querySelectorAll('.nav-item')[0].classList.add('active');
        if(viewId === 'shop') document.querySelectorAll('.nav-item')[1].classList.add('active');
        if(viewId === 'leaderboard') document.querySelectorAll('.nav-item')[2].classList.add('active');
        if(viewId === 'profile') document.querySelectorAll('.nav-item')[3].classList.add('active');
    },

    checkDaily() {
        const today = new Date().toDateString();
        if (User.data.lastLogin !== today) {
            document.getElementById('daily-card').style.display = 'block';
        } else {
            document.getElementById('daily-card').style.display = 'none';
        }
    },

    claimDaily() {
        User.data.gems += 50;
        User.data.lastLogin = new Date().toDateString();
        User.save();
        this.showModal("Daily Bonus", "Kamu dapat 50 Gems! üíé");
        document.getElementById('daily-card').style.display = 'none';
    },

    showModal(title, msg) {
        document.querySelector('#modal-reward h2').innerText = title;
        document.getElementById('reward-msg').innerText = msg;
        document.getElementById('modal-reward').classList.add('open');
    },

    generateLeaderboard() {
        const names = ["Alpha", "Beta", "Charlie", "Delta", "Echo"];
        const list = document.getElementById('lb-list');
        list.innerHTML = "";
        
        // Fake data + User
        let ranks = names.map(n => ({ name: n, score: Math.floor(Math.random() * 5000) + 1000 }));
        ranks.push({ name: User.data.name, score: User.data.stats.highScore });
        ranks.sort((a,b) => b.score - a.score);

        ranks.slice(0, 10).forEach((p, i) => {
            const isMe = p.name === User.data.name;
            const html = `
                <div class="rank-row" style="${isMe ? 'border:1px solid var(--primary);' : ''}">
                    <div class="rank-num">${i+1}</div>
                    <div class="rank-avatar" style="background:${isMe?'var(--primary)':'#333'}">${p.name[0]}</div>
                    <div>${p.name}</div>
                    <div class="rank-score">${p.score}</div>
                </div>
            `;
            list.innerHTML += html;
        });
    }
};

/* --- 3. GAME ENGINE (API & Logic) --- */
const Game = {
    active: false,
    score: 0,
    questions: [],
    qIndex: 0,
    timer: null,
    timeLeft: 15,
    isProcessing: false,

    // FALLBACK DB (Offline Mode)
    localDB: [
        { q: "Mata uang Jepang?", a: ["Yen", "Won", "Baht", "Dollar"], c: "Yen" },
        { q: "Ibukota Indonesia?", a: ["Jakarta", "Bandung", "Surabaya", "Medan"], c: "Jakarta" },
        { q: "Simbol kimia Air?", a: ["H2O", "O2", "CO2", "HO"], c: "H2O" },
        { q: "Planet terbesar?", a: ["Jupiter", "Mars", "Bumi", "Saturnus"], c: "Jupiter" },
        { q: "2 + 2 x 2?", a: ["6", "8", "4", "10"], c: "6" }
    ],

    async start(category) {
        if (User.data.energy <= 0) {
            alert("Energi habis! Beli di Shop atau tunggu.");
            return;
        }

        User.data.energy--;
        User.save();
        App.router('game');
        
        this.active = true;
        this.score = 0;
        this.qIndex = 0;
        document.getElementById('game-score').innerText = "0";
        document.getElementById('game-loader').classList.remove('hide');
        document.getElementById('game-content').classList.add('hide');

        // MAPPING CATEGORY FOR API (OpenTDB)
        let apiCat = 9; // General
        if(category === 'science') apiCat = 17;
        if(category === 'computer') apiCat = 18;

        try {
            // FETCH API
            const res = await fetch(`https://opentdb.com/api.php?amount=5&category=${apiCat}&type=multiple`);
            const data = await res.json();
            
            if(data.response_code === 0) {
                this.questions = data.results.map(item => {
                    // Decode HTML entities (dirty fix for &quot; etc)
                    const txt = document.createElement('textarea');
                    txt.innerHTML = item.question;
                    const qClean = txt.value;
                    
                    const answers = [...item.incorrect_answers, item.correct_answer].sort(() => Math.random() - 0.5);
                    return { q: qClean, a: answers, c: item.correct_answer };
                });
            } else {
                throw new Error("API Error");
            }
        } catch (e) {
            console.warn("Using Local DB");
            this.questions = [...this.localDB].sort(() => Math.random() - 0.5);
        }

        document.getElementById('game-loader').classList.add('hide');
        document.getElementById('game-content').classList.remove('hide');
        this.nextQuestion();
    },

    nextQuestion() {
        if (this.qIndex >= this.questions.length) return this.endGame();
        
        this.isProcessing = false;
        const q = this.questions[this.qIndex];
        
        document.getElementById('q-text').innerText = q.q;
        const opts = document.getElementById('options-container');
        opts.innerHTML = "";
        
        q.a.forEach((ans, i) => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerHTML = `<span class="opt-key">${['A','B','C','D'][i]}</span> <span>${ans}</span>`;
            btn.onclick = () => this.checkAnswer(ans, btn);
            opts.appendChild(btn);
        });

        this.startTimer();
    },

    startTimer() {
        clearInterval(this.timer);
        this.timeLeft = 15;
        const bar = document.getElementById('timer-bar');
        bar.style.width = "100%";
        bar.style.background = "var(--success)";

        this.timer = setInterval(() => {
            this.timeLeft--;
            bar.style.width = `${(this.timeLeft/15)*100}%`;
            
            if(this.timeLeft < 5) bar.style.background = "var(--danger)";
            
            if(this.timeLeft <= 0) {
                clearInterval(this.timer);
                this.timeOut();
            }
        }, 1000);
    },

    checkAnswer(ans, btn) {
        if(this.isProcessing) return;
        this.isProcessing = true;
        clearInterval(this.timer);

        const correct = this.questions[this.qIndex].c;
        
        if(ans === correct) {
            btn.classList.add('correct');
            this.score += 100 + (this.timeLeft * 5);
            AudioEngine.play('correct');
            if(navigator.vibrate) navigator.vibrate(50); // Haptic
        } else {
            btn.classList.add('wrong');
            AudioEngine.play('wrong');
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]); // Haptic
            
            // Highlight correct one
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => {
                if(b.innerText.includes(correct)) b.classList.add('correct');
            });
        }

        document.getElementById('game-score').innerText = this.score;

        setTimeout(() => {
            this.qIndex++;
            this.nextQuestion();
        }, 1500);
    },

    timeOut() {
        this.isProcessing = true;
        AudioEngine.play('wrong');
        const correct = this.questions[this.qIndex].c;
        // Highlight correct
        const allBtns = document.querySelectorAll('.opt-btn');
        allBtns.forEach(b => {
            if(b.innerText.includes(correct)) b.classList.add('correct');
        });
        
        setTimeout(() => {
            this.qIndex++;
            this.nextQuestion();
        }, 2000);
    },

    endGame() {
        this.active = false;
        User.data.stats.games++;
        if(this.score > User.data.stats.highScore) User.data.stats.highScore = this.score;
        
        // Calculate Rewards
        const xpEarned = Math.floor(this.score / 10);
        const gemsEarned = Math.floor(this.score / 200);
        
        User.addXP(xpEarned);
        User.data.gems += gemsEarned;
        User.save();

        App.showModal("Game Over", `Score: ${this.score}\n+${xpEarned} XP | +${gemsEarned} Gems`);
        App.router('home');
    }
};

/* --- 4. VOICE ENGINE --- */
const Voice = {
    rec: null,
    isListening: false,
    
    init() {
        if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.rec = new SR();
            this.rec.lang = 'en-US'; // Because OpenTDB is English usually
            this.rec.continuous = false;
            this.rec.interimResults = false;
            
            this.rec.onresult = (e) => {
                const txt = e.results[0][0].transcript.toLowerCase();
                this.process(txt);
            };
            this.rec.onend = () => {
                this.isListening = false;
                document.getElementById('voice-trigger').style.background = "rgba(255,255,255,0.1)";
            }
        } else {
            document.getElementById('voice-trigger').style.display = 'none';
        }
    },

    toggle() {
        if(!this.rec) return;
        if(this.isListening) {
            this.rec.stop();
        } else {
            this.rec.start();
            this.isListening = true;
            document.getElementById('voice-trigger').style.background = "var(--danger)";
        }
    },

    process(txt) {
        if(!Game.active || Game.isProcessing) return;
        // Simple heuristic mapping
        let idx = -1;
        if(txt.includes('one') || txt.includes('a')) idx = 0;
        else if(txt.includes('two') || txt.includes('b')) idx = 1;
        else if(txt.includes('three') || txt.includes('c')) idx = 2;
        else if(txt.includes('four') || txt.includes('d')) idx = 3;

        if(idx > -1) {
            const btns = document.querySelectorAll('.opt-btn');
            if(btns[idx]) btns[idx].click();
        }
    }
};

/* --- 5. SHOP LOGIC --- */
const Shop = {
    openChest() {
        if(User.data.gems < 100) return alert("Gems tidak cukup! Butuh 100.");
        User.data.gems -= 100;
        
        // Random Reward
        const rng = Math.random();
        let reward = "";
        if(rng > 0.8) {
            User.data.energy += 10;
            reward = "+10 Full Energy!";
        } else if (rng > 0.5) {
            User.addXP(200);
            reward = "+200 XP!";
        } else {
            User.data.energy += 3;
            reward = "+3 Energy";
        }
        
        User.save();
        App.showModal("Chest Opened!", reward);
    },

    buyEnergy() {
        if(User.data.gems < 50) return alert("Gems kurang.");
        User.data.gems -= 50;
        User.data.energy += 5;
        User.save();
        App.showModal("Energy Refilled", "Stamina bertambah +5 ‚ö°");
    }
};

/* --- 6. AUDIO ENGINE (Synthesizer - No Assets Needed) --- */
const AudioEngine = {
    ctx: null,
    init() { window.AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); },
    play(type) {
        if(!this.ctx) this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        
        const now = this.ctx.currentTime;
        if(type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        } else {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.2);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
            osc.start(now); osc.stop(now + 0.2);
        }
    }
};

// --- BOOTSTRAP ---
window.onload = () => {
    App.init();
    Voice.init();
    
    // Tap anywhere to init audio context (browser policy)
    document.body.addEventListener('click', () => {
        if(!AudioEngine.ctx) AudioEngine.init();
    }, {once:true});
};

</script>
</body>
</html>
